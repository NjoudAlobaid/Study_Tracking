<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dahoum: #0077b6; --remy: #7b2cbf; --active: #0077b6; }
        body { font-family: 'Cairo', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; transition: 0.5s; }
        .app-bar { background: white; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .btn-u { padding: 10px 25px; border: 2px solid #eee; border-radius: 50px; cursor: pointer; font-weight: bold; }
        body.dahoum-theme .btn-d { background: var(--dahoum); color: white; }
        body.remy-theme .btn-r { background: var(--remy); color: white; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        .card { background: white; border-radius: 25px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .p-img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--active); object-fit: cover; }
        .sync-status { position: fixed; bottom: 85px; left: 15px; font-size: 0.7rem; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 10px; z-index: 1000; }
        .hidden { display: none; }
        textarea { width: 100%; height: 150px; border-radius: 15px; padding: 15px; border: 1px solid #eee; font-family: 'Cairo'; }
        /* Ø§Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #eee; }
        .nav-item { border: none; background: none; font-family: 'Cairo'; cursor: pointer; color: #888; }
        .nav-item.active { color: var(--active); font-weight: bold; }
    </style>
</head>
<body class="dahoum-theme" id="bodyRoot">

    <div id="syncIndicator" class="sync-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨... â˜ï¸</div>

    <div class="app-bar">
        <button class="btn-u btn-d" onclick="switchUser('dahoum')">Ø¯Ø­ÙˆÙ… ğŸ‘¦</button>
        <button class="btn-u btn-r" onclick="switchUser('remy')">Ø±ÙŠÙ…ÙŠ ğŸ‘§</button>
    </div>

    <div class="container">
        <div class="card" style="text-align:center;">
            <div style="position:relative; display:inline-block;">
                <img id="userImg" class="p-img" src="https://via.placeholder.com/150">
                <input type="file" id="imgFile" class="hidden" onchange="uploadImg(event)">
                <button onclick="document.getElementById('imgFile').click()" style="position:absolute; bottom:0; right:0; border-radius:50%; border:none; padding:8px; cursor:pointer; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.2);">ğŸ“·</button>
            </div>
            <h2 id="welcomeName" style="margin:10px 0;">Ø¨Ø·Ù„Ù†Ø§ Ø¯Ø­ÙˆÙ…</h2>
            <div style="font-size:1.5rem; font-weight:900; color:#f1c40f;">â­ <span id="starPts">0</span></div>
        </div>

        <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
        <div id="sec-home">
            <div class="card">
                <h3>ğŸ“… Ù…ÙÙƒØ±Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
                <textarea id="diaryInput" oninput="saveAndSync()" placeholder="Ø§ÙƒØªØ¨ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…..."></textarea>
            </div>
        </div>

        <div id="sec-admin" class="hidden">
            <div class="card">
                <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</h3>
                <p style="font-size:0.8rem; color:#666;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                <input type="password" id="adminPass" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (123456)" style="width:100%; padding:10px; margin-bottom:10px;">
                <input type="text" id="ghToken" placeholder="GitHub Token (ghp_...)" style="width:100%; padding:10px; margin-bottom:10px;">
                <input type="text" id="ghRepo" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹" style="width:100%; padding:10px; margin-bottom:10px;">
                <button onclick="saveAdmin()" style="width:100%; padding:15px; background:var(--active); color:white; border:none; border-radius:10px; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ âœ…</button>
            </div>
        </div>
    </div>

    <div class="nav-bottom">
        <button class="nav-item active" onclick="showSec('home', this)">ğŸ  Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        <button class="nav-item" onclick="showSec('admin', this)">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </div>

<script>
    const CONFIG = {
        dahoum: { color: '#0077b6', name: 'Ø¯Ø­ÙˆÙ…' },
        remy: { color: '#7b2cbf', name: 'Ø±ÙŠÙ…ÙŠ' }
    };

    let currentUser = 'dahoum';
    let syncTimeout;

    // --- 1. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ---
    window.onload = async function() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        
        if (token && repo) {
            await fetchFromCloud(token, repo);
        }
        switchUser('dahoum');
    };

    async function fetchFromCloud(token, repo) {
        updateStatus("Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨... ğŸ”„");
        const url = `https://api.github.com/repos/${repo}/contents/database.json`;
        try {
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            if (res.ok) {
                const json = await res.json();
                const cloudData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
                Object.keys(cloudData).forEach(key => localStorage.setItem(key, cloudData[key]));
                updateStatus("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ âœ…");
            } else {
                updateStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø³Ø­Ø§Ø¨ÙŠØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ğŸ†•");
            }
        } catch (e) {
            updateStatus("ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª âŒ");
        }
    }

    // --- 2. Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ---
    function saveAndSync() {
        localStorage.setItem(currentUser + '_diary', document.getElementById('diaryInput').value);
        updateStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹... ğŸ’¾");
        
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(pushToCloud, 2000); // Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©
    }

    async function pushToCloud() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        if (!token || !repo) return;

        updateStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨... â˜ï¸");
        
        const data = {};
        for(let i=0; i<localStorage.length; i++){
            let key = localStorage.key(i);
            if(!key.startsWith('gh_')) data[key] = localStorage.getItem(key);
        }

        const url = `https://api.github.com/repos/${repo}/contents/database.json`;
        try {
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            let sha = res.ok ? (await res.json()).sha : "";
            
            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
                    sha: sha
                })
            });
            if (putRes.ok) updateStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        } catch (e) {
            updateStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨ âŒ");
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function switchUser(u) {
        currentUser = u;
        document.body.className = u + '-theme';
        document.documentElement.style.setProperty('--active', CONFIG[u].color);
        document.getElementById('welcomeName').innerText = "Ø¨Ø·Ù„Ù†Ø§ " + CONFIG[u].name;
        document.getElementById('starPts').innerText = localStorage.getItem(u + '_pts') || 0;
        document.getElementById('userImg').src = localStorage.getItem(u + '_img') || 'https://via.placeholder.com/150';
        document.getElementById('diaryInput').value = localStorage.getItem(u + '_diary') || '';
    }

    function uploadImg(e) {
        const reader = new FileReader();
        reader.onload = () => {
            document.getElementById('userImg').src = reader.result;
            localStorage.setItem(currentUser + '_img', reader.result);
            pushToCloud(); // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙˆØ±Ø§Ù‹
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function saveAdmin() {
        if (document.getElementById('adminPass').value !== "123456") return alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø®Ø·Ø£!");
        localStorage.setItem('gh_token', document.getElementById('ghToken').value);
        localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸! Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø§Ø¨.");
        pushToCloud();
    }

    function showSec(id, btn) {
        document.getElementById('sec-home').classList.add('hidden');
        document.getElementById('sec-admin').classList.add('hidden');
        document.getElementById('sec-' + id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        btn.classList.add('active');
    }

    function updateStatus(msg) {
        document.getElementById('syncIndicator').innerText = msg;
    }
</script>
</body>
</html>
